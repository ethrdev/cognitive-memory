<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>8</storyId>
    <title>MCP Server Daemonization &amp; Auto-Start</title>
    <status>drafted</status>
    <generatedAt>2025-11-18</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>bmad-docs/stories/3-8-mcp-server-daemonization-auto-start.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Entwickler</asA>
    <iWant>den MCP Server als Background-Prozess laufen lassen</iWant>
    <soThat>er automatisch beim Boot startet und nach Crashes neu startet</soThat>
    <tasks>
      <task id="1" ac="3.8.1">Create Systemd Service File
        <subtask>1.1: Create systemd/ directory in project root</subtask>
        <subtask>1.2: Create systemd/cognitive-memory-mcp.service file</subtask>
        <subtask>1.3: Configure [Unit] Section (Description, After, Wants)</subtask>
        <subtask>1.4: Configure [Service] Section (Type, User, WorkingDirectory, ExecStart, Restart, RestartSec, Environment)</subtask>
        <subtask>1.5: Configure Logging (StandardOutput, StandardError, SyslogIdentifier)</subtask>
        <subtask>1.6: Add Watchdog configuration (WatchdogSec=60)</subtask>
        <subtask>1.7: Configure [Install] Section (WantedBy=multi-user.target)</subtask>
      </task>
      <task id="2" ac="3.8.2,3.8.4">Install and Configure Service
        <subtask>2.1: Create installation script (scripts/install_service.sh)</subtask>
        <subtask>2.2: Script copies service file to /etc/systemd/system/</subtask>
        <subtask>2.3: Script runs systemctl daemon-reload</subtask>
        <subtask>2.4: Script runs systemctl enable cognitive-memory-mcp</subtask>
        <subtask>2.5: Add verification step (systemd-analyze verify)</subtask>
        <subtask>2.6: Document manual installation steps</subtask>
        <subtask>2.7: Update docs/production-checklist.md with systemd deployment section</subtask>
      </task>
      <task id="3" ac="3.8.5">Implement Health Check / Watchdog
        <subtask>3.1: Add systemd-python to project dependencies</subtask>
        <subtask>3.2: Implement Watchdog Heartbeat in mcp_server/main.py</subtask>
        <subtask>3.3: Implement Background Thread for Watchdog (runs every 30s)</subtask>
        <subtask>3.4: Add Startup Notification (daemon.notify("READY=1"))</subtask>
        <subtask>3.5: Add graceful shutdown (daemon.notify("STOPPING=1") on SIGTERM)</subtask>
        <subtask>3.6: Test Watchdog Failure (simulate missing heartbeats, verify auto-restart)</subtask>
      </task>
      <task id="4" ac="3.8.3">Logging Infrastructure Setup
        <subtask>4.1: Verify systemd Journal Integration (StandardOutput/StandardError)</subtask>
        <subtask>4.2: Test Journal Logging (start service, view logs via journalctl)</subtask>
        <subtask>4.3: Add SyslogIdentifier for unique log filtering</subtask>
        <subtask>4.4: Document Log Access Commands</subtask>
        <subtask>4.5: (Optional) Setup File-Based Structured Logging</subtask>
      </task>
      <task id="5" ac="3.8.4">Service Management Documentation
        <subtask>5.1: Create docs/systemd-deployment.md documentation</subtask>
        <subtask>5.2: Document Service Installation</subtask>
        <subtask>5.3: Document Service Management Commands</subtask>
        <subtask>5.4: Document Service Verification</subtask>
        <subtask>5.5: Document Troubleshooting</subtask>
        <subtask>5.6: Update docs/production-checklist.md</subtask>
      </task>
      <task id="6" ac="all">Testing and Validation
        <subtask>6.1: Test Service Installation</subtask>
        <subtask>6.2: Test Service Start/Stop</subtask>
        <subtask>6.3: Test Auto-Start bei Boot</subtask>
        <subtask>6.4: Test Auto-Restart bei Crash</subtask>
        <subtask>6.5: Test Logging</subtask>
        <subtask>6.6: Test Watchdog (if implemented)</subtask>
        <subtask>6.7: Test Environment Loading (ENVIRONMENT=production)</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="3.8.1" title="Systemd Service File (Linux)">
      Service file exists at /etc/systemd/system/cognitive-memory-mcp.service with correct configuration:
      - ExecStart: /home/user/i-o/venv/bin/python /home/user/i-o/mcp_server/main.py
      - Restart: always (auto-restart on crashes)
      - RestartSec: 10 (10 second delay before restart)
      - User: ethr (runs as non-root user)
      - WorkingDirectory: /home/user/i-o
      - Environment: ENVIRONMENT=production
    </criterion>
    <criterion id="3.8.2" title="Auto-Start bei Boot">
      Service is configured for auto-start:
      - systemctl enable cognitive-memory-mcp.service executed
      - Server starts automatically after system reboot
      - WantedBy: multi-user.target
      - Verification: After reboot, service runs without manual intervention
    </criterion>
    <criterion id="3.8.3" title="Logging Infrastructure">
      Logging correctly configured:
      - systemd Journal Integration (StandardOutput=journal, StandardError=journal)
      - SyslogIdentifier=cognitive-memory-mcp
      - Log queries work (journalctl -u cognitive-memory-mcp)
      - Optional: Structured logs at /var/log/cognitive-memory/mcp.log
    </criterion>
    <criterion id="3.8.4" title="Service Management Commands">
      Service management works correctly:
      - Start: systemctl start cognitive-memory-mcp
      - Stop: systemctl stop cognitive-memory-mcp
      - Restart: systemctl restart cognitive-memory-mcp
      - Status: systemctl status cognitive-memory-mcp
      - Enable/Disable: systemctl enable/disable cognitive-memory-mcp
    </criterion>
    <criterion id="3.8.5" title="Health Monitoring mit Systemd Watchdog">
      Health monitoring implemented:
      - WatchdogSec=60 in service file
      - Server sends heartbeat every 60s via sd_notify("WATCHDOG=1")
      - If no heartbeat after 60s, systemd performs auto-restart
      - systemd Python Package integrated for native Journal Integration
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>bmad-docs/tech-spec-epic-3.md</path>
        <title>Epic 3 Technical Specification</title>
        <section>Production Deployment - MCP Server Daemonization</section>
        <snippet>Epic 3 implements production-ready features including systemd Daemonization with auto-restart policy. MCP Server configured as systemd service for reliable operation and automatic startup.</snippet>
      </doc>
      <doc>
        <path>bmad-docs/epics.md</path>
        <title>Product Epics</title>
        <section>Story 3.8: MCP Server Daemonization & Auto-Start</section>
        <snippet>Story 3.8 defines systemd service configuration, auto-start behavior, logging infrastructure, service management commands, and health monitoring with watchdog.</snippet>
      </doc>
      <doc>
        <path>bmad-docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Service Management</section>
        <snippet>Architecture specifies systemd as the standard service management tool for Linux deployment, with auto-restart and logging capabilities.</snippet>
      </doc>
      <doc>
        <path>docs/production-checklist.md</path>
        <title>Production Deployment Checklist</title>
        <section>Deployment Steps</section>
        <snippet>Production checklist will be updated with systemd deployment section covering service installation, enablement, and verification.</snippet>
      </doc>
      <doc>
        <path>bmad-docs/stories/3-7-production-configuration-environment-setup.md</path>
        <title>Story 3.7 - Production Configuration & Environment Setup</title>
        <section>Environment Loading & .env.production</section>
        <snippet>Story 3.7 established environment separation with ENVIRONMENT=production variable. Systemd service must use this variable to load production configuration via mcp_server.config.load_environment().</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>mcp_server/__main__.py</path>
        <kind>entry_point</kind>
        <symbol>main server startup</symbol>
        <lines>27-34</lines>
        <reason>Main entry point that loads environment configuration at startup. Systemd ExecStart will invoke this file. Environment loading (Story 3.7) happens before local imports.</reason>
      </artifact>
      <artifact>
        <path>mcp_server/config.py</path>
        <kind>module</kind>
        <symbol>load_environment()</symbol>
        <lines>49-128</lines>
        <reason>Environment loading function from Story 3.7. Detects ENVIRONMENT variable, loads appropriate .env file, merges config, validates required variables. Systemd must set ENVIRONMENT=production for this to work correctly.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="Python Poetry">
        <package name="python" version="^3.11"/>
        <package name="mcp" version="^1.0.0"/>
        <package name="psycopg2-binary" version="^2.9.0"/>
        <package name="python-dotenv" version="^1.0.0"/>
        <package name="pyyaml" version="^6.0"/>
        <package name="systemd-python" version="to be added" note="Required for watchdog integration (daemon.notify)"/>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Service must run as non-root user 'ethr' for security (User=ethr in service file)</constraint>
    <constraint>Service must use ENVIRONMENT=production to load production configuration from Story 3.7</constraint>
    <constraint>Service must connect to production database 'cognitive_memory' (not 'cognitive_memory_dev')</constraint>
    <constraint>Service file location must be /etc/systemd/system/ (requires sudo for installation)</constraint>
    <constraint>Restart policy must be 'always' to ensure auto-restart on crashes</constraint>
    <constraint>RestartSec must be 10 seconds to prevent tight restart loops</constraint>
    <constraint>Service must depend on network.target and postgresql.service</constraint>
    <constraint>Logging must go to systemd Journal (StandardOutput=journal, StandardError=journal)</constraint>
    <constraint>Watchdog timeout must be 60 seconds (WatchdogSec=60)</constraint>
    <constraint>Heartbeat must be sent every 30-45 seconds (before 60s timeout)</constraint>
    <constraint>Service must send READY=1 notification after successful startup</constraint>
    <constraint>Service must send STOPPING=1 notification on graceful shutdown</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>load_environment()</name>
      <kind>Python function</kind>
      <signature>def load_environment() -> dict[str, Any]</signature>
      <path>mcp_server/config.py</path>
      <note>Loads environment-specific configuration. Called at startup in __main__.py. Requires ENVIRONMENT variable to be set.</note>
    </interface>
    <interface>
      <name>systemd daemon.notify()</name>
      <kind>System interface</kind>
      <signature>daemon.notify("WATCHDOG=1")</signature>
      <path>systemd Python package</path>
      <note>Sends heartbeat to systemd watchdog. Must be called periodically (every 30-45s) to prevent timeout and auto-restart.</note>
    </interface>
    <interface>
      <name>systemd daemon.notify() - startup</name>
      <kind>System interface</kind>
      <signature>daemon.notify("READY=1")</signature>
      <path>systemd Python package</path>
      <note>Notifies systemd that service has completed initialization and is ready to handle requests.</note>
    </interface>
    <interface>
      <name>systemd daemon.notify() - shutdown</name>
      <kind>System interface</kind>
      <signature>daemon.notify("STOPPING=1")</signature>
      <path>systemd Python package</path>
      <note>Notifies systemd that service is shutting down gracefully (on SIGTERM).</note>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing for Story 3.8 follows manual infrastructure testing pattern established in Story 3.7 (Production Configuration). Systemd service configuration requires real system infrastructure (systemd, sudo access) for validation. Testing includes: service installation verification, start/stop/restart commands, auto-start on boot, auto-restart on crash, logging via journalctl, and watchdog timeout simulation.
    </standards>
    <locations>
      No automated test files for systemd service management. Testing is manual and documented in docs/systemd-deployment.md and bmad-docs/stories/3-8-mcp-server-daemonization-auto-start.md (Task 6: Testing and Validation).
    </locations>
    <ideas>
      <idea ac="3.8.1">Manual Test: Create systemd/ directory, create service file, verify syntax with systemd-analyze verify cognitive-memory-mcp.service</idea>
      <idea ac="3.8.2">Manual Test: Run installation script, enable service (systemctl enable), reboot system, verify service running after reboot</idea>
      <idea ac="3.8.3">Manual Test: Start service, generate log output, query logs via journalctl -u cognitive-memory-mcp, verify logs visible</idea>
      <idea ac="3.8.4">Manual Test: Test all service management commands (start, stop, restart, status, enable, disable), verify expected behavior</idea>
      <idea ac="3.8.5">Manual Test: Implement watchdog heartbeat, monitor systemd status, simulate heartbeat failure (block thread), verify auto-restart after 60s timeout</idea>
      <idea ac="all">Integration Test: Full deployment test - install service, enable, start, verify production environment loaded, verify DB connection to cognitive_memory, verify logs, simulate crash (kill -9), verify auto-restart</idea>
    </ideas>
  </tests>
</story-context>
