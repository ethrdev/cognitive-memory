<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>9</storyId>
    <title>Staged Dual Judge Implementation (Enhancement E8)</title>
    <status>drafted</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>bmad-docs/stories/3-9-staged-dual-judge-implementation-enhancement-e8.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>MCP Server</asA>
    <iWant>Dual Judge schrittweise reduzieren (Phase 1: Dual → Phase 2: Single)</iWant>
    <soThat>Budget nach 3 Monaten von €5-10/mo auf €2-3/mo sinkt (-40%)</soThat>
    <tasks>
      <task id="1" ac="3.9.1">Kappa Evaluation Logic - Create staged_dual_judge.py module with calculate_macro_kappa() function, unit tests, and logging</task>
      <task id="2" ac="3.9.2,3.9.3">Transition Decision Engine - Implement evaluate_transition(), execute_transition(), and continue_dual_judge() functions with config.yaml updates</task>
      <task id="3" ac="3.9.4">Spot Check Implementation - Modify store_dual_judge_scores.py for random sampling, implement validate_spot_check_kappa(), add cron job</task>
      <task id="4" ac="3.9.4">Revert Logic - Implement revert_to_dual_judge() function with alert mechanism</task>
      <task id="5" ac="3.9.5">CLI Tool for Transition Management - Create staged_dual_judge_cli.py with --evaluate, --transition, --status, --validate-spot-checks commands</task>
      <task id="6" ac="3.9.2,3.9.4">Documentation - Create docs/staged-dual-judge.md, update production-checklist.md, add docstrings</task>
      <task id="7" ac="all">Testing and Validation - Test Kappa calculation, transition logic, spot checks, revert logic, CLI tool, integration testing</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="3.9.1">
      <title>IRR-Stabilität Check</title>
      <description>Load last 100 Ground Truth queries, calculate Macro-Average Kappa, determine transition eligibility (Kappa ≥0.85)</description>
      <details>
        - Load ground_truth table: ORDER BY created_at DESC LIMIT 100
        - Extract judge1_score and judge2_score arrays
        - Binary conversion: Score >0.5 = Relevant (1), ≤0.5 = Not Relevant (0)
        - Calculate Cohen's Kappa using sklearn.metrics.cohen_kappa_score()
        - Transition condition: Kappa ≥0.85 ("Almost Perfect Agreement")
        - Log: timestamp, kappa_value, num_queries, transition_eligible
      </details>
    </criterion>
    <criterion id="3.9.2">
      <title>Single Judge Mode Activation (if Kappa ≥0.85)</title>
      <description>Update config.yaml with dual_judge_enabled: false, set primary_judge: "gpt-4o", set spot_check_rate: 0.05</description>
      <details>
        - Configuration Changes: Update config/config.yaml using ruamel.yaml (preserve structure)
        - Cost Reduction: €5-10/mo → €2-3/mo (-40%)
        - Logging: "Transitioned to Single Judge Mode (Kappa: X.XX ≥ 0.85)"
        - Optional: Store transition event in transition_log table
      </details>
    </criterion>
    <criterion id="3.9.3">
      <title>Continue Dual Judge (if Kappa <0.85)</title>
      <description>No config changes, log warning, schedule re-evaluation</description>
      <details>
        - No config changes (dual_judge_enabled stays true)
        - Log Warning: "IRR below threshold for Single Judge transition (Kappa: X.XX < 0.85)"
        - Rationale: Judges disagree too often, more data needed
      </details>
    </criterion>
    <criterion id="3.9.4">
      <title>Spot Check Mechanismus (after transition)</title>
      <description>5% random sampling with both judges, monthly Kappa validation, automatic revert if Kappa <0.70</description>
      <details>
        - Random Sampling: if random.random() < 0.05 → call both judges
        - Store spot_check flag in metadata JSONB
        - Monthly validation: Calculate Kappa on spot check sample
        - Revert threshold: Kappa <0.70 → call revert_to_dual_judge()
        - Alert: PostgreSQL log + optional Email/Slack
      </details>
    </criterion>
    <criterion id="3.9.5">
      <title>Transition Management CLI</title>
      <description>CLI tool with --evaluate, --transition, --status, --validate-spot-checks commands</description>
      <details>
        - --evaluate: Display current Kappa, recommendation, cost projection
        - --transition: Confirm and execute transition
        - --status: Show current mode, spot check Kappa
        - --validate-spot-checks: Cron job command for monthly validation
        - Output formats: Table (tabulate) or JSON
      </details>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>bmad-docs/tech-spec-epic-3.md</path>
        <title>Epic 3 Technical Specification</title>
        <section>Story 3.9: Staged Dual Judge Implementation</section>
        <snippet>Implements Enhancement E8 for budget optimization. Transitions from Full Dual Judge to Single Judge + 5% Spot Checks based on Kappa ≥0.85 threshold. Cost reduction: €5-10/mo → €2-3/mo (-40%).</snippet>
      </doc>
      <doc>
        <path>bmad-docs/epics.md</path>
        <title>i-o - Epic Breakdown</title>
        <section>Story 3.9: Staged Dual Judge Implementation (Enhancement E8)</section>
        <snippet>Budget optimization story. Implements data-driven transition from Dual Judge to Single Judge + Spot Checks. Transition criteria: Kappa ≥0.85 over 100 queries. Safety net: Automatic revert if spot check Kappa <0.70.</snippet>
      </doc>
      <doc>
        <path>bmad-docs/architecture.md</path>
        <title>Cognitive Memory System v3.1.0-Hybrid - Architektur</title>
        <section>NFR003: Budget & Cost Efficiency</section>
        <snippet>Budget target: €5-10/mo (Phase 1), €2-3/mo (Phase 2 after Staged Dual Judge). Cost optimization via IRR-based feature toggle. Dual Judge cost: €4-6/mo (main cost driver).</snippet>
      </doc>
      <doc>
        <path>bmad-docs/architecture.md</path>
        <title>Cognitive Memory System v3.1.0-Hybrid - Architektur</title>
        <section>Configuration Management</section>
        <snippet>config.yaml with environment-specific overrides. Environment Variable: ENVIRONMENT=production|development. Config loading via mcp_server/config.py. File permissions: chmod 600 for .env files.</snippet>
      </doc>
      <doc>
        <path>bmad-docs/architecture.md</path>
        <title>Cognitive Memory System v3.1.0-Hybrid - Architektur</title>
        <section>API-Integration: Anthropic API (Haiku) + OpenAI API (GPT-4o)</section>
        <snippet>Haiku Dual Judge: claude-3-5-haiku-20241022, Cost: ~€1-1.5/mo. GPT-4o Dual Judge: gpt-4o, Cost: ~€4-6/mo. Retry-Logic: 4 retries with exponential backoff.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>mcp_server/tools/dual_judge.py</path>
        <kind>tool</kind>
        <symbol>store_dual_judge_scores</symbol>
        <lines>1-500</lines>
        <reason>Existing Dual Judge implementation (Story 1.11). Needs modification in Task 3 to add spot check logic with random sampling based on dual_judge_enabled config flag.</reason>
      </artifact>
      <artifact>
        <path>mcp_server/tools/irr_validation.py</path>
        <kind>tool</kind>
        <symbol>validate_irr</symbol>
        <lines>1-300</lines>
        <reason>Existing IRR Validation implementation (Story 1.12). Provides Kappa calculation baseline. Story 3.9 extends with transition logic and spot check validation.</reason>
      </artifact>
      <artifact>
        <path>mcp_server/utils/retry_logic.py</path>
        <kind>utility</kind>
        <symbol>retry_with_backoff</symbol>
        <lines>1-200</lines>
        <reason>Existing retry logic with exponential backoff (Story 3.3). Pattern can be reused for config update retries if needed.</reason>
      </artifact>
      <artifact>
        <path>mcp_server/config.py</path>
        <kind>config</kind>
        <symbol>load_config</symbol>
        <lines>1-200</lines>
        <reason>Config loading module. Story 3.9 needs to add dual_judge_enabled, primary_judge, spot_check_rate to config schema.</reason>
      </artifact>
      <artifact>
        <path>config/config.yaml</path>
        <kind>config</kind>
        <symbol>N/A</symbol>
        <lines>N/A</lines>
        <reason>Main configuration file. Story 3.9 adds new section for Staged Dual Judge with dual_judge_enabled, primary_judge, spot_check_rate, kappa_threshold, spot_check_kappa_threshold.</reason>
      </artifact>
      <artifact>
        <path>mcp_server/utils/</path>
        <kind>directory</kind>
        <symbol>N/A</symbol>
        <lines>N/A</lines>
        <reason>Target directory for new staged_dual_judge.py module (Task 1). Existing utils include query_expansion.py, reflexion_utils.py, retry_logic.py, fallback_logger.py.</reason>
      </artifact>
      <artifact>
        <path>scripts/</path>
        <kind>directory</kind>
        <symbol>N/A</symbol>
        <lines>N/A</lines>
        <reason>Target directory for new staged_dual_judge_cli.py CLI tool (Task 5) and validate_spot_checks.sh cron script (Task 3.4).</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="scikit-learn" version="^1.3.0">sklearn.metrics.cohen_kappa_score for Kappa calculation</package>
        <package name="psycopg2-binary" version="^2.9.0">PostgreSQL database access for ground_truth table queries</package>
        <package name="pyyaml" version="^6.0">YAML parsing (existing)</package>
        <package name="ruamel.yaml" version="TBD">YAML structure preservation for config updates (NEW - to be added)</package>
        <package name="argparse" version="stdlib">CLI argument parsing for staged_dual_judge_cli.py</package>
        <package name="tabulate" version="TBD">CLI table output formatting (NEW - to be added)</package>
        <package name="python-dotenv" version="^1.0.0">Environment variable loading (existing)</package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>All code must follow existing project patterns from mcp_server/ structure</constraint>
    <constraint>Use ruamel.yaml for config.yaml updates to preserve YAML comments and structure</constraint>
    <constraint>Kappa calculation must use sklearn.metrics.cohen_kappa_score() for consistency with Story 1.12</constraint>
    <constraint>Config changes must not require MCP Server restart (hot reload preferred)</constraint>
    <constraint>Spot check rate must be configurable (default 0.05, but support 0.0-1.0 range)</constraint>
    <constraint>All transitions and reverts must be logged to PostgreSQL with timestamps</constraint>
    <constraint>CLI tool must support both table and JSON output formats (--format json flag)</constraint>
    <constraint>Spot check flag stored in metadata JSONB (no schema migration required)</constraint>
    <constraint>Monthly spot check validation via cron job (0 0 1 * * - 1st of month)</constraint>
    <constraint>Documentation in Deutsch (German) per document_output_language config</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>calculate_macro_kappa</name>
      <kind>function</kind>
      <signature>def calculate_macro_kappa(num_queries: int = 100) -> Dict[str, Union[float, int, bool]]</signature>
      <path>mcp_server/utils/staged_dual_judge.py</path>
      <returns>{"kappa": float, "num_queries": int, "transition_eligible": bool}</returns>
    </interface>
    <interface>
      <name>evaluate_transition</name>
      <kind>function</kind>
      <signature>def evaluate_transition(kappa_threshold: float = 0.85) -> Dict[str, Union[str, float, bool]]</signature>
      <path>mcp_server/utils/staged_dual_judge.py</path>
      <returns>{"decision": str, "kappa": float, "ready": bool, "rationale": str}</returns>
    </interface>
    <interface>
      <name>execute_transition</name>
      <kind>function</kind>
      <signature>def execute_transition() -> None</signature>
      <path>mcp_server/utils/staged_dual_judge.py</path>
      <description>Updates config.yaml: dual_judge_enabled=false, primary_judge="gpt-4o", spot_check_rate=0.05</description>
    </interface>
    <interface>
      <name>validate_spot_check_kappa</name>
      <kind>function</kind>
      <signature>def validate_spot_check_kappa() -> None</signature>
      <path>mcp_server/utils/staged_dual_judge.py</path>
      <description>Calculates Kappa on spot checks from last 30 days, reverts if Kappa <0.70</description>
    </interface>
    <interface>
      <name>revert_to_dual_judge</name>
      <kind>function</kind>
      <signature>def revert_to_dual_judge(spot_check_kappa: float) -> None</signature>
      <path>mcp_server/utils/staged_dual_judge.py</path>
      <description>Restores config.yaml: dual_judge_enabled=true, logs revert event</description>
    </interface>
    <interface>
      <name>ground_truth table</name>
      <kind>database</kind>
      <signature>Table(id, query, expected_docs, judge1_score, judge2_score, judge1_model, judge2_model, kappa, metadata JSONB, created_at)</signature>
      <path>PostgreSQL database</path>
      <description>metadata->>'spot_check' = 'true'/'false' flag added for spot check tracking</description>
    </interface>
    <interface>
      <name>config.yaml staged_dual_judge section</name>
      <kind>configuration</kind>
      <signature>dual_judge_enabled: bool, primary_judge: str, spot_check_rate: float, kappa_threshold: float, spot_check_kappa_threshold: float</signature>
      <path>config/config.yaml</path>
      <description>Configuration section for Staged Dual Judge feature toggle and thresholds</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Story 3.9 follows existing test patterns from tests/ directory. Unit tests use pytest framework (pyproject.toml [tool.pytest.ini_options]). Test files follow naming convention test_*.py. Existing dual judge tests in test_dual_judge.py and test_irr_validation.py provide baseline patterns. Mock data required for Kappa calculation tests (perfect/random/moderate agreement). Config update tests must verify YAML structure preservation using ruamel.yaml. Integration test deferred to post-3-months production (requires real Kappa data).
    </standards>
    <locations>
      tests/ - Main test directory
      tests/test_dual_judge.py - Existing Dual Judge tests (Story 1.11 baseline)
      tests/test_irr_validation.py - Existing IRR Validation tests (Story 1.12 baseline)
      tests/test_staged_dual_judge.py - NEW test file for Story 3.9 unit tests
      tests/manual/ - Manual test scripts directory
    </locations>
    <ideas>
      <idea ac="3.9.1">Test calculate_macro_kappa() with mock ground_truth data: perfect agreement (Kappa=1.0), random (Kappa≈0), moderate (Kappa≈0.6). Verify sklearn output match. Test edge case: <100 queries available.</idea>
      <idea ac="3.9.2">Test execute_transition() config update: Mock Kappa ≥0.85, verify config.yaml dual_judge_enabled=false. Use ruamel.yaml diff to verify structure preserved. Test idempotency (run twice safely).</idea>
      <idea ac="3.9.3">Test continue_dual_judge(): Mock Kappa <0.85, verify no config changes, warning logged. Test log message format matches expected.</idea>
      <idea ac="3.9.4">Test spot check sampling: Mock spot_check_rate=0.05, run 100 queries, verify 4-6 spot checks (binomial distribution). Test spot_check_rate=1.0 for testing mode (100% spot checks).</idea>
      <idea ac="3.9.4">Test validate_spot_check_kappa(): Mock spot check Kappa <0.70, verify revert_to_dual_judge() called. Mock Kappa ≥0.70, verify no revert. Test with <5 spot checks (insufficient sample warning).</idea>
      <idea ac="3.9.4">Test revert_to_dual_judge(): Verify config.yaml dual_judge_enabled=true restored. Test idempotency. Verify log message format.</idea>
      <idea ac="3.9.5">Test CLI --evaluate: Mock Kappa values, verify output format (table/JSON). Test --transition with user confirmation. Test --status display. Test --validate-spot-checks exit codes (0 success, 1 revert).</idea>
      <idea ac="all">Integration test (deferred): After 3 months production, verify actual transition with real data. Compare api_cost_log Month 3 (€5-10) vs Month 4 (€2-3). Document in 7-day-stability-report.md.</idea>
    </ideas>
  </tests>
</story-context>
